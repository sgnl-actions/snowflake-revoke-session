# Snowflake Revoke Session Action

This action revokes all active sessions for a Snowflake user by temporarily disabling and then re-enabling the user account.

## Quick Start

1. **Clone** this repository locally
2. **Install dependencies**: `npm install`
3. **Configure** your Snowflake API credentials
4. **Test locally**: `npm run dev`
5. **Run tests**: `npm test`
6. **Build**: `npm run build`
7. **Release**: Create a git tag and push

## Input Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `username` | String | Yes | The Snowflake username to revoke sessions for |
| `delay` | Duration | No | Delay between disable and re-enable operations (e.g., 100ms, 1s). Default: 100ms |
| `address` | String | No | Snowflake API base URL (e.g., https://api.snowflakecomputing.com) |

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ADDRESS` | `https://api.snowflakecomputing.com` | Snowflake API base URL (can also be provided via `address` parameter) |

## Authentication

This action supports multiple authentication methods. Configure the appropriate secrets and environment variables based on your chosen authentication method:

### Bearer Token Authentication
- `BEARER_AUTH_TOKEN` (secret) - Your Snowflake API Bearer token (JWT or OAuth)

### Basic Authentication
- `BASIC_USERNAME` (secret) - Your Snowflake username
- `BASIC_PASSWORD` (secret) - Your Snowflake password

### OAuth2 Client Credentials
- `OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET` (secret) - OAuth2 client secret
- `OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID` (environment) - OAuth2 client ID
- `OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL` (environment) - OAuth2 token endpoint URL
- `OAUTH2_CLIENT_CREDENTIALS_SCOPE` (environment) - OAuth2 scopes (optional)
- `OAUTH2_CLIENT_CREDENTIALS_AUDIENCE` (environment) - OAuth2 audience (optional)
- `OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE` (environment) - OAuth2 auth style (optional)

### OAuth2 Authorization Code
- `OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN` (secret) - OAuth2 access token

## Development

### Local Testing

```bash
# Run the script locally with mock data
npm run dev

# Run unit tests
npm test

# Watch mode for development
npm run test:watch
npm run build:watch

# Validate metadata
npm run validate

# Lint code
npm run lint
npm run lint:fix
```

### File Structure

- `src/script.mjs` - Main job implementation (⚠️ **Edit this!**)
- `metadata.yaml` - Job schema and configuration (⚠️ **Edit this!**)
- `tests/script.test.js` - Unit tests
- `dist/index.js` - Built script (generated by `npm run build`)
- `scripts/` - Development utilities

## Output

The action returns the following information:

| Field | Type | Description |
|-------|------|-------------|
| `username` | String | The Snowflake username that was processed |
| `sessionsRevoked` | Boolean | Whether the sessions were successfully revoked |
| `userDisabled` | String | Statement handle or status for the disable operation |
| `userReEnabled` | String | Statement handle or status for the re-enable operation |
| `revokedAt` | DateTime | When the revocation completed (ISO 8601) |

## How It Works

This action revokes Snowflake sessions by:
1. Disabling the user account (which revokes all active sessions)
2. Waiting for a configurable delay (default: 100ms)
3. Re-enabling the user account

The delay ensures that the disable operation completes before re-enabling the account.

## Event Handlers

Your script must export a default object with these handlers:

### `invoke` (Required)
Main execution logic for your job.

```javascript
invoke: async (params, context) => {
  // Your job logic here
  return {
    status: 'success',
    // ... other outputs
  };
}
```

### `error` (Optional)
Error recovery logic when `invoke` fails.

```javascript
error: async (params, context) => {
  // params.error contains the original error
  // Attempt recovery or cleanup
  return {
    status: 'recovered',
    // ... recovery results
  };
}
```

### `halt` (Optional)  
Graceful shutdown when job is cancelled or times out.

```javascript
halt: async (params, context) => {
  // params.reason contains halt reason
  // Clean up resources, save partial progress
  return {
    status: 'halted',
    cleanup_completed: true
  };
}
```

## Context Object

The `context` parameter provides access to:

```javascript
{
  env: {
    ENVIRONMENT: "production",
    // ... other environment variables
  },
  secrets: {
    API_KEY: "secret-key",
    // ... other secrets
  },
  outputs: {
    "previous-job-step": {
      // ... outputs from previous jobs in workflow
    }
  }
}
```

## Testing

### Unit Tests

Tests are in `tests/script.test.js`. Update the mock data to match your job's inputs:

```javascript
const params = {
  target: 'your-target',
  action: 'your-action'
  // ... other inputs
};
```

### Local Development

Use `npm run dev` to test your script locally with mock data. Update `scripts/dev-runner.js` to customize the test parameters.

## Deployment

1. **Ensure tests pass**: `npm test`
2. **Validate metadata**: `npm run validate`  
3. **Build distribution**: `npm run build`
4. **Create git tag**: `git tag v1.0.0`
5. **Push to GitHub**: `git push origin v1.0.0`

## Usage Examples

### Bearer Token Authentication

```json
{
  "id": "snowflake-revoke-session-123",
  "type": "nodejs-20",
  "script": {
    "repository": "github.com/sgnl-actions/snowflake-revoke-session",
    "version": "v1.0.0",
    "type": "nodejs"
  },
  "script_inputs": {
    "username": "JOHN_DOE",
    "delay": "100ms",
    "address": "https://api.snowflakecomputing.com"
  },
  "environment": {
    "ADDRESS": "https://api.snowflakecomputing.com"
  },
  "secrets": {
    "BEARER_AUTH_TOKEN": "your-snowflake-jwt-token"
  }
}
```

### OAuth2 Client Credentials

```json
{
  "id": "snowflake-revoke-session-124",
  "type": "nodejs-20",
  "script": {
    "repository": "github.com/sgnl-actions/snowflake-revoke-session",
    "version": "v1.0.0",
    "type": "nodejs"
  },
  "script_inputs": {
    "username": "JOHN_DOE",
    "delay": "100ms"
  },
  "environment": {
    "ADDRESS": "https://api.snowflakecomputing.com",
    "OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID": "your-client-id",
    "OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL": "https://your-org.snowflakecomputing.com/oauth/token",
    "OAUTH2_CLIENT_CREDENTIALS_SCOPE": "session:role:ACCOUNTADMIN"
  },
  "secrets": {
    "OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET": "your-client-secret"
  }
}
```

## Token Type Detection

When using Bearer token authentication, the action automatically detects the token type:
- JWT tokens (with 3 parts separated by dots) are treated as KEYPAIR_JWT
- Other tokens are treated as OAUTH tokens

This detection adds the appropriate `X-Snowflake-Authorization-Token-Type` header to API requests.

## Support

